stages:
  - deploy
variables:
  SSH_PRIVATE_KEY: ${SSH_PRIVATE_KEY}
  DEPLOY_USER: ${DEPLOY_USER}
  DEPLOY_SERVER: ${DEPLOY_SERVER}
  DEPLOY_SERVER_PORT: ${DEPLOY_SERVER_PORT} 
  DEPLOY_PATH: ${DEPLOY_PATH}
  DISCORD_WEBHOOK: ${DISCORD_WEBHOOK}

before_script:
  - 'which ssh-agent || apt-get update -y && apt-get install -y openssh-client'
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - ssh-keyscan -p ${DEPLOY_SERVER_PORT} -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
  - chmod 644 ~/.ssh/known_hosts

deploy:
  stage: deploy
  script:
    - echo "🚀 Iniciando o deploy para $DEPLOY_SERVER..."
    - |
      ssh $DEPLOY_USER@$DEPLOY_SERVER -p ${DEPLOY_SERVER_PORT} << EOF
        set -e
        cd ${DEPLOY_PATH} || exit 1
        echo \${PWD}
        echo "🔄 Atualizando repositório..."
        git fetch --all
        git reset --hard origin/main
        echo "📦 Instalando dependências do Composer..."
        composer install --no-dev --optimize-autoloader || exit 1
        echo "📜 Rodando migrations do Laravel..."
        php artisan migrate --force || exit 1
        echo "📦 Instalando dependências do NPM..."
        npm install || exit 1
        echo "🛠️ Realizando o build do Vue3..."
        npm run build || exit 1
        echo "🧹 Limpando e otimizando caches..."
        php artisan cache:clear
        php artisan config:clear
        php artisan route:clear
        php artisan view:clear
        echo "✅ Deploy concluído com sucesso!"
        echo "Enviando notificação para o Discord..."
        curl -X POST \
          -H "Content-Type: application/json" \
          -d "{
            \"username\": \"Deploy Bot\",
            \"avatar_url\": \"https://cdn-icons-png.flaticon.com/512/1087/1087815.png\",
            \"embeds\": [{
              \"title\": \"🚀 Deploy Concluído!\",
              \"description\": \"O deploy para o servidor **${DEPLOY_SERVER}** foi concluído com sucesso.\",
              \"color\": 3066993,
              \"fields\": [
                { \"name\": \"Servidor\", \"value\": \"${DEPLOY_SERVER}\", \"inline\": true },
                { \"name\": \"Status\", \"value\": \"✅ Sucesso\", \"inline\": true },
                { \"name\": \"Porta\", \"value\": \"${DEPLOY_SERVER_PORT}\", \"inline\": false }
                { \"name\": \"Caminho\", \"value\": \"${DEPLOY_PATH}\", \"inline\": false }
              ],
              \"timestamp\": \"$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")\"
            }]
          }" \
          $DISCORD_WEBHOOK
      EOF
    - echo "🎉 Deploy concluído no servidor ${DEPLOY_SERVER} porta ${DEPLOY_SERVER_PORT}!"

  only:
    - main  # Garantir que o deploy só ocorra na branch 'main'
  except:
    - dev  # Ignorar execução do pipeline na branch 'dev'
